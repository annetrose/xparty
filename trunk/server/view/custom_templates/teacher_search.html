{% extends "teacher.html" %}
{# vim: set sw=2 ts=2 expandtab: #}

{% block custom_head %}
<script type="text/javascript">
    
    var QUERY_PANE = "query";
    var WORD_PANE = "word";
    var LINK_PANE = "link";
    var ANSWER_PANE = "answer";
    
    g_customDataPanes[QUERY_PANE] = { title: 'Queries' };
    g_customDataPanes[WORD_PANE] = { title: 'Words' };
    g_customDataPanes[LINK_PANE] = { title: 'Links' };
    g_customDataPanes[ANSWER_PANE] = { title: 'Responses' };
    
    
    function load_custom_pane(paneKey, div) {
        switch(paneKey) {
            case QUERY_PANE:
                load_query_pane(div);
                break;
            default:
                div.html("Not implemented yet");
                break;
        }
    }
    
    function update_custom_pane(paneKey, action) {
        switch(paneKey) {
            case QUERY_PANE:
                update_query_pane(action);
                break;
            default:
                break;
        }
    }
    
    //=================================================================================
    // Query Pane
    //=================================================================================

    function load_query_pane(div) {
        var accumulator = new DataAccumulator();
        var taskIdx = selectedTaskIdx();
        var taskHistory = g_task_histories[taskIdx];
        var answers = [];
        for (var i=0; i<taskHistory.length; i++) {
            var action = taskHistory[i];
            if (action.action_type == "query") {
                item = new DataItem(action.action_data.query, action);
                accumulator.add(item);
            }
        }
           
        var html = '<h3 id="pane_title" style="margin-bottom:10px">'+g_customDataPanes[QUERY_PANE].title+'</h3>';
        html += '<div id="tag_cloud" class="tag_cloud"></div>';
        html += '<div id="data_list"></div>';
        div.html(html);
    
        var tagcloud = new TagCloud($("#tag_cloud"), accumulator);
        tagcloud.show();
        
        var accordion = new QueryAccordion($("#data_list"), accumulator);
        accordion.show();
    }
    
    function update_query_pane(action) {
        if (g_accordion) {
            var is_action_defined = typeof(action) != "undefined";
            var is_query_action = is_action_defined && action.action_type == "query"; 
        
            // if new answer, add to accumulator
            if (is_query_action) {
                var item = new DataItem(action.action_data.query, action);
                g_accordion.accumulator.add(item);
            }
            
            // if new query, redraw pane
            // if no action, redraw pane (e.g., sort or filter)
            if (!is_action_defined || is_query_action) {
                g_accordion.show();
                g_tagcloud.show();
            }          
        }
    }
    
    function QueryAccordion(div, accumulator) {
        AccordionList.call(this, div, accumulator);
    }
    QueryAccordion.prototype = Object.create(AccordionList.prototype);
    
    QueryAccordion.prototype.expandedItem = function(key, i) {
        var student_dict = {};
        var items = this.accumulator.dict[key];
        for (var j=0; j<items.length; j++) {
            var data = items[j].getData();
            var nickname = data["student_nickname"];
            if (typeof(student_dict[nickname]) == "undefined") {
                student_dict[nickname] = [];
            }
            student_dict[nickname].push(data);
        }
        
        var html = get_student_list_html(student_dict);
        html += "<h2>NEED TO ADD OTHER STUFF</h2>";
        return html;
    }
       
</script>
{% endblock %}